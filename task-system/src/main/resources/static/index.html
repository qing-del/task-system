<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>AI è¿›åŒ–ç³»ç»Ÿ - æ§åˆ¶å°</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --bg: #f5f6fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--primary); padding: 20px; max-width: 800px; margin: 0 auto; }

        /* å¸ƒå±€å®¹å™¨ */
        .container { display: grid; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        /* çŠ¶æ€é¢æ¿ */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        .stat-item h3 { font-size: 2em; margin: 0; color: var(--accent); }
        .stat-item p { margin: 5px 0 0; color: #7f8c8d; font-size: 0.9em; }

        /* ç»éªŒæ¡ */
        .exp-bar-bg { background: #eee; height: 10px; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .exp-bar-fill { background: linear-gradient(90deg, #f1c40f, #e67e22); height: 100%; width: 0%; transition: width 0.5s ease; }

        /* æŒ‰é’® */
        .btn-ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; transition: transform 0.1s; }
        .btn-ai:active { transform: scale(0.98); }
        .btn-ai:disabled { opacity: 0.7; cursor: wait; }

        /* ä»»åŠ¡å¡ç‰‡ */
        .task-card { border-left: 5px solid var(--accent); background: #fff; padding: 15px; margin-top: 15px; animation: slideIn 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
        .task-info h4 { margin: 0 0 5px 0; }
        .task-reward { font-size: 0.85em; color: #e67e22; background: #fff3cd; padding: 2px 8px; border-radius: 4px; }
        .btn-complete { background: var(--success); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="stats-grid">
            <div class="stat-item">
                <h3 id="level">1</h3>
                <p>ç­‰çº§ (Level)</p>
            </div>
            <div class="stat-item">
                <h3 id="spirit">0</h3>
                <p>ç²¾ç¥ (Spirit)</p>
            </div>
            <div class="stat-item">
                <h3 id="body">0</h3>
                <p>è‚‰ä½“ (Body)</p>
            </div>
            <div class="stat-item">
                <h3 id="points">0</h3>
                <p>æ€»ç»éªŒ (Total)</p>
            </div>
        </div>
        <div class="exp-bar-bg">
            <div id="expBar" class="exp-bar-fill"></div>
        </div>
        <p style="text-align: right; font-size: 0.8em; color: #999; margin-top: 5px;">
            å½“å‰ç»éªŒ: <span id="curExp">0</span> / <span id="maxExp">100</span>
        </p>
    </div>

    <div class="card">
        <button class="btn-ai" onclick="generateAiTask()" id="aiBtn">
            âœ¨ å¬å”¤ AI ç”Ÿæˆæ–°ä»»åŠ¡
        </button>
    </div>

    <div id="taskList">
    </div>
</div>

<script>
    const BASE_URL = 'http://localhost:8080/task';
    const PLAYER_ID = 1; // é»˜è®¤æµ‹è¯•ç©å®¶ID

    // åˆå§‹åŒ–åŠ è½½
    window.onload = refreshStatus;

    // --- æ ¸å¿ƒåŠŸèƒ½ 1: åˆ·æ–°çŠ¶æ€ ---
    async function refreshStatus() {
        try {
            const res = await fetch(`${BASE_URL}/status?playerId=${PLAYER_ID}`);
            const p = await res.json();

            // æ›´æ–°æ•°å­—
            document.getElementById('level').innerText = p.level;
            document.getElementById('spirit').innerText = p.spirit;
            document.getElementById('body').innerText = p.body;
            document.getElementById('points').innerText = p.totalExp;
            document.getElementById('curExp').innerText = p.currentExp;
            document.getElementById('maxExp').innerText = p.totalExp; // æ³¨æ„ï¼šä½ ä»£ç é‡Œ totalExp å®é™…ä¸Šæ˜¯å‡çº§é—¨æ§›

            // æ›´æ–°ç»éªŒæ¡
            const percent = Math.min((p.currentExp / p.totalExp) * 100, 100);
            document.getElementById('expBar').style.width = `${percent}%`;
        } catch (e) {
            console.error("åŠ è½½çŠ¶æ€å¤±è´¥:", e);
        }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ 2: AI ç”Ÿæˆä»»åŠ¡ ---
    async function generateAiTask() {
        const btn = document.getElementById('aiBtn');
        btn.disabled = true;
        btn.innerText = "ğŸ¤– AI æ­£åœ¨æ€è€ƒä¸­... (è¿™å¯èƒ½éœ€è¦å‡ ç§’)";

        try {
            const res = await fetch(`${BASE_URL}/generate?playerId=${PLAYER_ID}`, { method: 'POST' });
            if (!res.ok) throw new Error("ç”Ÿæˆå¤±è´¥");

            const task = await res.json();
            renderTask(task); // æŠŠä»»åŠ¡ç”»åœ¨é¡µé¢ä¸Š
        } catch (e) {
            alert("AI ä¼¼ä¹å¼€å°å·®äº†ï¼Œè¯·æ£€æŸ¥åç«¯æ§åˆ¶å°æ—¥å¿—");
        } finally {
            btn.disabled = false;
            btn.innerText = "âœ¨ å¬å”¤ AI ç”Ÿæˆæ–°ä»»åŠ¡";
        }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ 3: å®Œæˆä»»åŠ¡ ---
    async function completeTask(taskId, btnElement) {
        try {
            const res = await fetch(`${BASE_URL}/complete?playerId=${PLAYER_ID}&taskId=${taskId}`, { method: 'POST' });
            const updatedPlayer = await res.json();

            // 1. åˆ·æ–°ä¸Šé¢çš„ç©å®¶é¢æ¿
            refreshStatus();

            // 2. ç§»é™¤è¿™ä¸ªä»»åŠ¡å¡ç‰‡
            const card = btnElement.closest('.task-card');
            card.style.opacity = '0';
            setTimeout(() => card.remove(), 300);

            // 3. ç®€å•çš„å‡çº§ç‰¹æ•ˆæç¤º
            if (updatedPlayer.level > parseInt(document.getElementById('level').innerText)) {
                alert("ğŸ‰ æ­å–œå‡çº§ï¼Level Up!");
            }
        } catch (e) {
            alert("ç»“ç®—å¤±è´¥");
        }
    }

    // è¾…åŠ©å·¥å…·ï¼šæŠŠä»»åŠ¡æ•°æ®å˜æˆ HTML
    function renderTask(task) {
        const list = document.getElementById('taskList');
        const rewardText = task.rewardType === 0 ? `ç²¾ç¥ +${task.reward}` : `è‚‰ä½“ +${task.reward}`;

        const html = `
                <div class="task-card">
                    <div class="task-info">
                        <h4>${task.title}</h4>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">${task.description}</div>
                        <span class="task-reward">EXP +${task.expReward}</span>
                        <span class="task-reward">${rewardText}</span>
                    </div>
                    <button class="btn-complete" onclick="completeTask(${task.id}, this)">âœ… å®Œæˆ</button>
                </div>
            `;
        // æ’å…¥åˆ°åˆ—è¡¨æœ€å‰é¢
        list.insertAdjacentHTML('afterbegin', html);
    }
</script>
</body>
</html>